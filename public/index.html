<!DOCTYPE html>
<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.8.335/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js"></script>
</head>
<body>

<input type="file" id="pdfInput" accept=".pdf">
<div id="outputImages"></div>
<div id="outputResults"></div>

<script>
document.getElementById('pdfInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  
  if (file) {
    const reader = new FileReader();
    
    reader.onload = async function(event) {
      const arrayBuffer = event.target.result;
      const loadingTask = pdfjsLib.getDocument(arrayBuffer);
      
      loadingTask.promise.then(async function(pdf) {
        const resultObj = {}; // Crear un objeto JSON para almacenar los resultados
        
        for (let pageNumber = 1; pageNumber <= pdf.numPages; pageNumber++) {
          const page = await pdf.getPage(pageNumber);
          const viewport = page.getViewport({ scale: 1.5 });
          
          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          const renderContext = {
            canvasContext: context,
            viewport: viewport
          };
          
          await page.render(renderContext).promise;
          
          const imgDataUrl = canvas.toDataURL('image/png');
          
          // Realizar OCR en la imagen utilizando tesseract.js
          const result = await Tesseract.recognize(imgDataUrl);
          
          // Procesar y organizar los resultados del OCR
          const processedResult = processAndOrganizeResult(result.data.text);
          
          // Agregar el resultado procesado al objeto JSON
          resultObj[`page_${pageNumber}`] = processedResult;
        }
        
        // Mostrar los resultados en el HTML
        displayResults(resultObj);
      });
    };
    
    reader.readAsArrayBuffer(file);
  }
});

function processAndOrganizeResult(ocrText) {
  const lines = ocrText.split('\n');
  const jsonObject = {
    empresa: lines[0],
    direccion: lines[1],
    factura: lines[2],
    cliente: lines[3],
    direccion_cliente: lines[4],
    numero_pedido: lines[5],
    fecha_vencimiento: lines[6],
    items: [],
    subtotal: "",
    iva: "",
    total: "",
    condiciones_pago: ""
  };

  // Procesar líneas para los items (puedes usar un bucle para más items)
  jsonObject.items.push({
    cantidad: parseFloat(lines[7].split(" ")[0]),
    descripcion: lines[7].substring(lines[7].indexOf(" ") + 1),
    precio_unitario: parseFloat(lines[8].split(" ")[3]),
    importe: parseFloat(lines[8].split(" ")[5])
  });

  // Procesar las líneas restantes para subtotal, iva, total y condiciones de pago
  jsonObject.subtotal = parseFloat(lines[9].split(" ")[1]);
  jsonObject.iva = parseFloat(lines[10].split(" ")[1]);
  jsonObject.total = parseFloat(lines[11].split(" ")[1]);
  jsonObject.condiciones_pago = lines.slice(12).join(" ");

  return jsonObject;
}


function displayResults(results) {
  const outputElement = document.getElementById('outputResults');
  outputElement.innerHTML = ''; // Limpiar el contenido anterior
  
  for (const pageNumber in results) {
    const pageResult = results[pageNumber];
    const table = document.createElement('table');
    table.style.borderCollapse = 'collapse';
    table.style.margin = '20px';
    
    for (const key in pageResult) {
      const value = pageResult[key];
      
      const row = table.insertRow();
      const cell1 = row.insertCell();
      const cell2 = row.insertCell();
      
      cell1.style.padding = '5px';
      cell1.style.border = '1px solid #ccc';
      cell1.style.fontWeight = 'bold';
      cell1.textContent = key;
      
      cell2.style.padding = '5px';
      cell2.style.border = '1px solid #ccc';
      cell2.textContent = value;
      
      table.appendChild(row);
    }
    
    outputElement.appendChild(table);
  }
}

</script>

</body>
</html>
